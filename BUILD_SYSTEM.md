# Magic JS Build System

This monorepo implements a custom build system using a combination of tools:

- [Yarn](https://yarnpkg.com) (for dependency management)
- [`wsrun`](https://github.com/hfour/wsrun) (for running workspace scripts)
- [ESBuild](https://esbuild.github.io) (for transpilation, minifaction, and bundling of source codes)
- [TypeScript](https://www.typescriptlang.org) (for static typing)
- [ESLint](https://eslint.org) (for TypeScript/JavaScript linting)e

These tools work together based upon some ground rules around repo organization and architecture.

## Understanding Generated Files (`packages/**/dist`)

ESBuild works in tandem with `tsc` (TypeScript) to generate production-ready code bundles that are published to NPM, along with TypeScript definition files to support strongly-typed integrations with Magic JS packages.

A typical `/dist` folder generated by the build system will look like this:

```
packages/*
└── dist/
    ├── cjs/
    │   ├── index.js             # CommonJS entrypoint
    │   └── index.js.map
    ├── es/
    │   ├── index.js             # ES entrypoint
    │   ├── index.js.map
    │   ├── index.mjs            # ES entrypoint using .mjs extension
    │   └── index.mjs.map
    ├── react-native/
    │   ├── index.native.js      # React Native entrypoint
    │   └── index.native.js.map
    └── types/
        └── *.d.ts               # TypeScript entrypoint(s)
```

We generate multiple outputs in order to maximize backwards compatibility and interoperability across JS runtimes. These outputs are associated with entrypoints configured in `package.json`. Here are the relevant configuration values, explained:

```js
{
  // One of: node | browser | neutral
  //
  //      node:  Targets Node-like runtimes; used for React Native libraries
  //             (i.e.: `@magic-sdk/react-native`)
  //   browser:  Targets web-like runtimes; used for web-only libraries
  //             (i.e.: `magic-sdk`)
  //   neutral:  Targets universal runtimes; used for libraries that are used
  //             across React Native & web (i.e.: most `@magic-ext/*` packages)
  "target": "...",

  // If a CDN bundle should be required,
  // this determines its global variable name
  // (attached to `window` in the browser)
  "cdnGlobalName": "...",

  // Output location for CJS entrypoint
  "main": "./dist/cjs/index.js",

  // Output location for ES entrypoint
  "module": "./dist/es/index.js",

  // Output location for TypeScript definition files
  "types": "./dist/types/index.d.ts",

  // Output location for CDN entrypoint
  "jsdelivr": "./dist/my-library.js",

  // Output location for React Native entrypoint
  "react-native": "./dist/react-native/index.native.js",

  // Here, we define a standard NodeJS "exports" field...
  "exports": {
    // Output location for ES entrypoint using `.mjs` extensions.
    "import": "./dist/es/index.mjs",
    // Output location for CJS entrypoint
    // (this should be exactly the same as the value defined in "main",
    //  it's repeated here for redundancy and backwards-compatibility reasons)
    "require": "./dist/cjs/index.js"
  },
}
```

The build system will choose which outputs to generate based upon the configuration specified (or omitted).

## Defining Sources (`packages/**/src`)

Each entrypoint type (**CJS**, **ES**, **React Native**, and **CDN**) can define a separate source file as its starting point for bundling, using a unique file identifier.

- **CJS**: `src/index.cjs.ts`
- **ES**: `src/index.es.ts`
- **React Native**: `src/index.native.ts`
- **CDN**: `src/index.cdn.ts`

All entrypoint types will fall back to `src/index.ts` if a type-specific source file undefined.

## Bootstrapping New SDK Extensions (`packages/@magic-ext/*`)

Monorepos tend to require lots of same-y boilerplate. The most common boilerplate in this repo can be found within [`packages/@magic-ext`](./packages/@magic-ext) to support a number of niche or case-specific Magic SDK extensions. Creating new extensions requires lots of copy/pasting and little tweaks that are prone to human error. So, we created a scaffolding script to make the process a cinch!

Simply run the following command, then answer a few interactive prompts:

```zsh
yarn scaffold
```
